<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditSafety Platform vCOMPLETE - Panel Interactivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> 

    <style>
        /* --- ESTILOS CSS PROFESIONALES INTEGRADOS (COMPLETOS Y CORREGIDOS) --- */
        /* >>> INICIO DEL BLOQUE CSS COMPLETO <<< */
        /* COPIA AQUÍ TODO EL CSS DE LA RESPUESTA ANTERIOR DONDE TE DI EL BLOQUE CSS CORREGIDO */
        /* Este bloque es extenso (más de 600 líneas) y define toda la apariencia "Pro". */
        /* Asegúrate de incluir desde :root hasta el final de las @media queries. */
        /* Ejemplo del inicio (NO ES EL CSS COMPLETO, SOLO PARA UBICARTE): */
        :root {
            --color-primary: #007BFF; 
            --color-primary-dark: #0056b3;
            --color-primary-light: #cfe2ff; 
            --color-accent: #FF8C00; 
            /* ... más variables ... */
            --color-primary-rgb: 0, 123, 255;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans-serif); background-color: var(--color-bg-body);
            color: var(--color-text-dark); line-height: 1.6; display: flex;
            font-size: 15px; overflow-x: hidden; 
        }
        /* ... HASTA EL FINAL DE LAS @media queries ... */
        /* Pega aquí el CSS que te di en la respuesta titulada: */
        /* "Okay, ¡lo tengo! Pido disculpas por esos "huecos" en el CSS..." */
        /* Reemplaza este comentario con esas ~700 líneas de CSS. */

        /* ESTILOS CSS COMPLETOS DE LA VERSIÓN ANTERIOR (PROPORCIONADOS POR EL USUARIO O ANTERIORMENTE) */
        /* ... (Asegúrate de que este bloque CSS esté aquí completo) ... */
        :root {
            --color-primary: #007BFF; /* Azul principal, más vibrante */
            --color-primary-dark: #0056b3;
            --color-primary-light: #cfe2ff; /* Azul muy claro para fondos o acentos */
            
            --color-accent: #FF8C00; /* Naranja de Audit Safety */
            --color-accent-dark: #cc7000;

            --color-success: #198754; /* Verde éxito, más oscuro */
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-info: #0dcaf0; /* Un celeste para información */

            --color-text-dark: #212529;
            --color-text-medium: #495057;
            --color-text-light: #6c757d;
            
            --color-bg-body: #f0f2f5; 
            --color-bg-main: #FFFFFF; 
            --color-border: #dee2e6; 
            
            --color-sidebar-bg: #0d1a2e; 
            --color-sidebar-link: #a0aec0; 
            --color-sidebar-link-hover-bg: #1a2b42; 
            --color-sidebar-link-active-bg: var(--color-primary);
            --color-sidebar-link-active-text: #FFFFFF;
            --color-sidebar-submenu-bg: #152337; 
            --color-sidebar-logo-border: var(--color-accent);

            --font-family-sans-serif: "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,.05);
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --shadow-md: 0 .5rem 1rem rgba(0,0,0,.1);
            --shadow-lg: 0 1rem 3rem rgba(0,0,0,.125);
            --border-radius: .375rem; 
            --sidebar-width: 280px;
            --header-height: 70px;
            --color-primary-rgb: 0, 123, 255;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans-serif); background-color: var(--color-bg-body);
            color: var(--color-text-dark); line-height: 1.6; display: flex;
            font-size: 15px; overflow-x: hidden; 
        }
        a { text-decoration: none; color: var(--color-primary); transition: color 0.2s ease; }
        a:hover { color: var(--color-primary-dark); }
        ul { list-style: none; }
        h1, h2, h3, h4, h5, h6 { font-weight: 600; line-height: 1.3; color: var(--color-text-dark);}

        .page-wrapper { display: flex; width: 100%; min-height: 100vh; }

        .sidebar {
            width: var(--sidebar-width); background-color: var(--color-sidebar-bg);
            color: var(--color-sidebar-link); display: flex; flex-direction: column;
            position: fixed; top: 0; left: 0; height: 100%; z-index: 1001;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); box-shadow: var(--shadow-lg);
        }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #2d3748; }
        .sidebar-logo-container { margin-bottom: 10px; }
        .sidebar-logo-container img {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid var(--color-sidebar-logo-border); object-fit: cover;
            display: block; margin: 0 auto 8px auto; background-color: var(--color-bg-white); 
        }
        .sidebar-app-name { font-size: 1.2rem; font-weight: 700; color: var(--color-bg-white); display: block; }
        .sidebar-app-name .accent { color: var(--color-accent); }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
        .sidebar-nav::-webkit-scrollbar { width: 5px; }
        .sidebar-nav::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 3px; }
        .sidebar-nav ul { padding: 0; margin: 0; }
        .sidebar-nav li .nav-link, .sidebar-nav li .submenu-toggle {
            display: flex; align-items: center; padding: 12px 20px;
            color: var(--color-sidebar-link); font-size: 0.9rem; font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease, padding-left 0.2s ease, border-left-color 0.2s ease;
            cursor: pointer; position: relative; border-left: 4px solid transparent;
        }
        .sidebar-nav li .nav-link i, .sidebar-nav li .submenu-toggle i {
            margin-right: 12px; width: 20px; text-align: center;
            font-size: 1em; opacity: 0.7; transition: opacity 0.2s ease;
        }
        .sidebar-nav li .nav-link:hover, .sidebar-nav li .submenu-toggle:hover {
            background-color: var(--color-sidebar-link-hover-bg); color: #FFFFFF;
            padding-left: 24px; border-left-color: var(--color-sidebar-link-hover-bg);
        }
        .sidebar-nav li .nav-link:hover i, .sidebar-nav li .submenu-toggle:hover i { opacity: 0.9; }
        .sidebar-nav li.active > .nav-link, .sidebar-nav li.active > .submenu-toggle {
            background-color: var(--color-sidebar-link-active-bg);
            color: var(--color-sidebar-link-active-text); font-weight: 600;
            padding-left: 20px; border-left-color: var(--color-accent);
        }
        .sidebar-nav li.active > .nav-link i, .sidebar-nav li.active > .submenu-toggle i { opacity: 1; }
        .sidebar-nav .submenu-toggle .fa-chevron-right { margin-left: auto; font-size: 0.65em; transition: transform 0.25s ease; }
        .sidebar-nav li.open > .submenu-toggle .fa-chevron-right { transform: rotate(90deg); }
        .sidebar-nav .submenu {
            background-color: var(--color-sidebar-submenu-bg); max-height: 0; overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .sidebar-nav .submenu a.nav-link { padding: 10px 20px 10px 40px; font-size: 0.85rem; opacity: 0.85; }
        .sidebar-nav .submenu a.nav-link:hover { background-color: var(--color-sidebar-link-hover-bg); color: #FFFFFF; padding-left: 45px; }
        .sidebar-nav .submenu li.active-sub > a.nav-link { color: var(--color-accent); font-weight: 500; background-color: transparent; }
        .sidebar-nav .submenu a.nav-link i { 
            font-size: 0.85em; margin-right: 10px; width: 16px; display: inline-block; opacity: 0.6;
         }

        .main-content-wrapper {
            flex-grow: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column;
            transition: margin-left 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); background-color: var(--color-bg-body);
        }
        .main-header {
            background-color: var(--color-bg-main); height: var(--header-height); padding: 0 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--color-border);
            position: sticky; top: 0; z-index: 1000;
        }
        .main-header .menu-toggle-btn {
            display: none; font-size: 1.4rem; background: none; border: none;
            color: var(--color-text-medium); cursor: pointer; padding: 10px;
        }
        .main-header .page-title { font-size: 1.5rem; color: var(--color-text-dark); margin: 0; }
        .user-actions a {
            color: var(--color-text-medium); font-weight: 500; display: flex; align-items: center;
            padding: 8px 12px; border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .user-actions a:hover { background-color: var(--color-primary-light); color: var(--color-primary-dark); }
        .user-actions a i { margin-right: 8px; }

        .content-area { padding: 25px; flex-grow: 1; overflow-y: auto; }
        
        .custom-card {
            background-color: var(--color-bg-main); padding: 20px 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm); margin-bottom: 25px; border: 1px solid var(--color-border);
        }
        .custom-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border);
        }
        .custom-card-header h2, .custom-card-header h3 { margin: 0; font-size: 1.2rem; }
        
        .btn {
            padding: .5rem 1rem; font-size: .875rem; font-weight: 500;
            border-radius: var(--border-radius); border: 1px solid transparent; cursor: pointer;
            transition: all .2s ease; text-align: center; display: inline-flex;
            align-items: center; gap: .4em;
        }
        .btn-sm { padding: .4rem .8rem; font-size: .8rem; }
        .btn-primary { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .btn-primary:hover { background-color: var(--color-primary-dark); border-color: var(--color-primary-dark); }
        .btn-accent { background-color: var(--color-accent); color: white; border-color: var(--color-accent); }
        .btn-accent:hover { background-color: var(--color-accent-dark); border-color: var(--color-accent-dark); }
        .btn-outline-primary { color: var(--color-primary); border-color: var(--color-primary); background-color:transparent; }
        .btn-outline-primary:hover { background-color: var(--color-primary); color: white; }
        .action-icon { color: var(--color-text-light); margin: 0 5px; font-size: 1.1em; cursor:pointer; }
        .action-icon:hover { color: var(--color-primary); }

        .summary-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 20px; }
        .summary-card {
            background-color: var(--color-bg-main); padding: 20px; border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
            border: 1px solid var(--color-border); transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .summary-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .summary-card::before { 
            content: ''; position: absolute; top: 0; left: 0; height: 5px; width: 100%;
        }
        .summary-card.cumple::before { background-color: var(--color-success); }
        .summary-card.no-cumple::before { background-color: var(--color-danger); }
        .summary-card.observacion::before { background-color: var(--color-warning); }
        .summary-card.info::before { background-color: var(--color-info); }

        .summary-card-content { display: flex; justify-content: space-between; align-items: center; }
        .summary-card-info h3 { font-size: 0.9rem; color: var(--color-text-light); margin-bottom: 4px; text-transform: uppercase; font-weight: 500;}
        .summary-card-info .value { font-size: 1.8rem; font-weight: 700; color: var(--color-text-dark); }
        .summary-card-icon { font-size: 2.2rem; opacity: 0.15; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        .summary-card.cumple .summary-card-icon { color: var(--color-success); }
        .summary-card.no-cumple .summary-card-icon { color: var(--color-danger); }
        .summary-card.observacion .summary-card-icon { color: var(--color-warning); }
        .summary-card.info .summary-card-icon { color: var(--color-info); }

        .chart-outer-container { 
             margin-bottom:25px; background-color:var(--color-bg-main); 
             border-radius:var(--border-radius); box-shadow:var(--shadow-sm); 
             border: 1px solid var(--color-border); padding: 20px;
        }
        .chart-outer-container h3 { 
            font-size: 1.15rem; margin-bottom:20px; text-align:center; 
            color: var(--color-text-medium); font-weight:500;
        }
        .chart-canvas-wrapper { 
            position: relative;
            height: 300px; 
            width: 100%;
        }
         .chart-canvas-wrapper.line-chart { 
            height: 340px; 
        }
        
        .data-table { width: 100%; border-collapse: collapse; background-color: var(--color-bg-main); box-shadow: var(--shadow-xs); border-radius: var(--border-radius); overflow: hidden; border: 1px solid var(--color-border); }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 0.875rem;}
        .data-table thead th { background-color: #f8f9fc; color: var(--color-text-medium); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: #f1f5f9; }
        
        .risk-level { padding: .25em .6em; font-size: .75em; font-weight: 700; border-radius: .25rem; display: inline-block;}
        .risk-high { background-color: var(--color-danger); color: white; }
        .risk-medium { background-color: var(--color-warning); color: var(--color-text-dark); }
        .risk-low { background-color: var(--color-success); color: white; }
        
        .status-badge { padding: .3em .7em; border-radius: var(--border-radius); font-size: .8em; font-weight: 500; color: var(--color-bg-white); white-space: nowrap; display: inline-block;}
        .status-cumple { background-color: var(--color-success); }
        .status-no-cumple { background-color: var(--color-danger); }
        .status-pendiente { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-en-progreso { background-color: var(--color-primary); }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 20px; }
        .form-group { margin-bottom: 1.1rem; }
        .form-group label { display: block; margin-bottom: .4rem; font-weight: 500; color: var(--color-text-medium); font-size: 0.875rem;}
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="time"], .form-group input[type="number"], .form-group input[type="email"], .form-group select, .form-group textarea {
            width: 100%; padding: .65rem .9rem; font-size: .9rem; font-family: var(--font-family-sans-serif);
            border: 1px solid var(--color-border); border-radius: var(--border-radius);
            background-color: var(--color-bg-main); color: var(--color-text-dark);
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--color-primary); outline: 0;
            box-shadow: 0 0 0 .2rem rgba(var(--color-primary-rgb),.25);
        }
        .form-group input:read-only { background-color: #e9ecef; opacity: 1; cursor: not-allowed; }
        .form-group textarea { min-height: 90px; resize: vertical; }
        .form-actions { margin-top: 1.75rem; display:flex; justify-content: flex-end; gap: 10px; }

        .success-message, .info-message, .error-message-form {
            padding: .9rem 1.1rem; margin-bottom: 1.25rem; border: 1px solid transparent;
            border-radius: var(--border-radius); text-align: center; font-size: 0.9rem;
        }
        .success-message { color: #0f5132; background-color: #d1e7dd; border-color: #badbcc; }
        .info-message { color: #055160; background-color: #cff4fc; border-color: #b6effb; }
        .error-message-form { color: #842029; background-color: #f8d7da; border-color: #f5c2c7; }

        .main-footer { text-align: center; padding: 20px; background-color: var(--color-bg-main); border-top: 1px solid var(--color-border); font-size: 0.85rem; color: var(--color-text-light); margin-top: auto; }

        .modal {
            display: none; position: fixed; z-index: 1050; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(17, 24, 39, 0.8); 
            padding-top: 30px; padding-bottom: 30px; backdrop-filter: blur(3px);
        }
        .modal-content {
            background-color: var(--color-bg-main); margin: auto; padding: 25px 30px;
            border: 1px solid var(--color-border); border-radius: var(--border-radius);
            width: 90%; max-width: 750px; 
            box-shadow: var(--shadow-lg); position: relative;
            animation: slideInModal 0.3s ease-out;
        }
        @keyframes slideInModal { from {transform: translateY(-30px) scale(0.98); opacity: 0;} to {transform: translateY(0) scale(1); opacity: 1;} }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--color-border);
        }
        .modal-header h2 { margin: 0; font-size: 1.4rem; color: var(--color-primary); }
        .modal-close-btn {
            color: var(--color-text-light); font-size: 1.8rem; font-weight: bold;
            background: none; border: none; cursor: pointer; padding: 0 5px; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--color-danger); }
        .modal-body { max-height: 65vh; overflow-y:auto; padding-right: 10px; }
        .modal-body p { margin-bottom: 10px; line-height: 1.7; font-size: 0.95rem; }
        .modal-body strong { color: var(--color-text-medium); }
        .modal-body .detail-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px 18px; margin-bottom: 15px; font-size: 0.9rem;
        }
        .modal-footer {
            padding-top: 20px; margin-top: 20px;
            border-top: 1px solid var(--color-border); text-align: right;
        }
        
        /* Checklist Styles */
        .checklist-item {
            padding: 10px; margin-bottom: 8px;
            border: 1px solid var(--color-border); border-radius: var(--border-radius);
            background-color: #fdfdff;
        }
        .checklist-item-header { font-weight: 600; color: var(--color-text-medium); margin-bottom: 5px; }
        .checklist-item-criteria { font-size: 0.85rem; color: var(--color-text-light); margin-bottom: 8px; }
        .checklist-qualification { display: flex; gap: 10px; margin-bottom: 8px; }
        .checklist-qualification label { font-size: 0.85rem; cursor:pointer; display:flex; align-items:center; }
        .checklist-qualification input[type="radio"] { margin-right: 5px; }
        .checklist-observacion-area { display: none; margin-top: 8px; }
        .checklist-observacion-area textarea { width:100%; font-size:0.85rem; padding:8px; min-height: 60px; }

        @media (max-width: 992px) {
            .sidebar { transform: translateX(calc(-1 * var(--sidebar-width))); box-shadow: none; }
            .sidebar.open { transform: translateX(0); box-shadow: var(--shadow-lg); }
            .main-content-wrapper { margin-left: 0; }
            .main-header .menu-toggle-btn { display: block; }
        }
        @media (max-width: 768px) {
            .main-header { padding: 0 20px; }
            .main-header .page-title { font-size: 1.25rem; }
            .user-actions .logout-text { display: none; }
            .summary-cards { grid-template-columns: 1fr; }
            .content-area { padding: 20px; }
            .custom-card { padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .btn { padding: .5rem 1rem; font-size: .85rem; }
            .modal-content { width: 95%; padding: 20px; }
            .modal-header h2 {font-size: 1.3rem;}
            .charts-row-1 { grid-template-columns: 1fr !important; } 
        }
        @media (max-width: 576px) {
             :root { --sidebar-width: 240px; } 
            .sidebar-app-name { font-size: 1.1rem; }
            .sidebar-logo-container img { width: 60px; height: 60px; border-width: 2px;}
            .sidebar-nav li .nav-link, .sidebar-nav li .submenu-toggle { padding: 12px 20px; font-size: 0.9rem; }
            .sidebar-nav li .nav-link i, .sidebar-nav li .submenu-toggle i { font-size: 1em; margin-right: 12px; }
            .sidebar-nav .submenu a.nav-link { padding: 10px 20px 10px 40px; font-size: 0.85rem;}
            .content-area { padding: 15px; }
            .custom-card { padding: 15px; }
            .custom-card-header h2, .custom-card-header h3 { font-size: 1.1rem; }
        }
        /* --- FIN DEL BLOQUE CSS COMPLETO --- */
    </style>
</head>
<body>
    <div class="page-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#dashboard" class="sidebar-logo-container nav-trigger" data-page-name="Dashboard Principal">
                    <img src="ChatGPT Image 5 jun 2025, 11_56_31 a.m..png" alt="Audit Safety Logo">
                </a>
                <a href="#dashboard" class="sidebar-app-name nav-trigger" data-page-name="Dashboard Principal">Audit<span class="accent">Safety</span></a>
            </div>
            <nav class="sidebar-nav">
                 <ul>
                    <li class="active"> 
                        <a href="#dashboard" class="nav-link nav-trigger" data-page-name="Dashboard Principal"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li>
                        <span class="submenu-toggle"><i class="fas fa-clipboard-list"></i> Auditorías <i class="fas fa-chevron-right"></i></span>
                        <ul class="submenu">
                            <li><a href="#nuevaAuditoria" class="nav-link nav-trigger" data-page-name="Programar Auditoría"><i class="fas fa-calendar-plus"></i>Programar</a></li>
                            <li><a href="#ejecutarAuditoria" class="nav-link nav-trigger" data-page-name="Ejecutar Auditoría"><i class="fas fa-play-circle"></i>Ejecutar</a></li>
                            <li><a href="#auditoriasActivas" class="nav-link nav-trigger" data-page-name="Auditorías Activas"><i class="fas fa-spinner"></i>Activas</a></li>
                            <li><a href="#historialAuditorias" class="nav-link nav-trigger" data-page-name="Historial de Auditorías"><i class="fas fa-history"></i>Historial</a></li>
                        </ul>
                    </li>
                    <li>
                        <span class="submenu-toggle"><i class="fas fa-file-signature"></i> Actas e Informes <i class="fas fa-chevron-right"></i></span>
                        <ul class="submenu">
                            <li><a href="#actaApertura" class="nav-link nav-trigger" data-page-name="Acta de Apertura"><i class="fas fa-folder-open"></i>Acta Apertura</a></li>
                            <li><a href="#actaCierre" class="nav-link nav-trigger" data-page-name="Acta de Cierre"><i class="fas fa-folder-closed"></i>Acta Cierre</a></li>
                            <li><a href="#informeHallazgos" class="nav-link nav-trigger" data-page-name="Informe de Hallazgos"><i class="fas fa-file-alt"></i>Informe Hallazgos</a></li>
                            <li><a href="#informeFinal" class="nav-link nav-trigger" data-page-name="Informe Final Consolidado"><i class="fas fa-file-invoice"></i>Informe Final</a></li>
                        </ul>
                    </li>
                    <li>
                        <span class="submenu-toggle"><i class="fas fa-shield-halved"></i> Gestión SG-SST <i class="fas fa-chevron-right"></i></span>
                        <ul class="submenu">
                            <li><a href="#gestionarPlantillas" class="nav-link nav-trigger" data-page-name="Plantillas y Checklists"><i class="fas fa-list-check"></i>Plantillas/Checklists</a></li>
                            <li><a href="#gestionHallazgos" class="nav-link nav-trigger" data-page-name="Gestión de Hallazgos"><i class="fas fa-magnifying-glass-chart"></i>Hallazgos</a></li>
                            <li><a href="#accionesCorrectivas" class="nav-link nav-trigger" data-page-name="Acciones Correctivas"><i class="fas fa-tasks-alt"></i>Acciones Correctivas</a></li>
                            <li><a href="#clasificacionRiesgos" class="nav-link nav-trigger" data-page-name="Matriz de Riesgos"><i class="fas fa-shield-virus"></i>Matriz de Riesgos</a></li>
                            <li><a href="#normativa" class="nav-link nav-trigger" data-page-name="Normativa y Documentos"><i class="fas fa-book-open"></i>Normativa</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#reportesGraficas" class="nav-link nav-trigger" data-page-name="Reportes y Gráficas"><i class="fas fa-chart-line"></i> Reportes y Gráficas</a>
                    </li>
                     <li>
                        <a href="#alertasNotificaciones" class="nav-link nav-trigger" data-page-name="Alertas y Notificaciones"><i class="fas fa-bell"></i> Alertas</a>
                    </li>
                    <li>
                        <a href="#configuracion" class="nav-link nav-trigger" data-page-name="Configuración"><i class="fas fa-cog"></i> Configuración</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <div class="main-content-wrapper" id="mainContentWrapper">
            <header class="main-header">
                <button class="menu-toggle-btn" id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                <h1 class="page-title" id="pageTitle">Dashboard Principal</h1>
                <div class="user-actions">
                    <a href="index.html" id="logoutButton" title="Cerrar Sesión"><i class="fas fa-sign-out-alt"></i> <span class="logout-text">Cerrar Sesión</span></a>
                </div>
            </header>

            <main class="content-area" id="contentArea">
                </main>

            <footer class="main-footer">
                <p>&copy; <span id="currentYear"></span> AuditSafety Platform. Todos los derechos reservados.</p>
                <p>SG-SST Conforme al Decreto 1072 de 2015 y normatividad aplicable.</p>
            </footer>
        </div>
    </div>

    <div id="auditDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalle de Auditoría</h2>
                <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBodyContent"></div>
            <div class="modal-footer">
                <button class="btn btn-outline-primary" id="modalCloseBtnFooter">Cerrar</button>
                 <button class="btn btn-primary" id="modalEditBtn"><i class="fas fa-edit"></i> Continuar/Editar Auditoría</button>
            </div>
        </div>
    </div>

<script>
// --- JAVASCRIPT INTERACTIVO CON GRÁFICAS Y NUEVAS SECCIONES (CORREGIDO Y AMPLIADO) ---
document.addEventListener('DOMContentLoaded', function() {
    // --- REFERENCIAS A ELEMENTOS DEL DOM ---
    const sidebar = document.getElementById('sidebar');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const pageTitleElement = document.getElementById('pageTitle');
    const contentArea = document.getElementById('contentArea');
    const yearSpan = document.getElementById('currentYear');

    // Modal elements
    const auditDetailModal = document.getElementById('auditDetailModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBodyContent = document.getElementById('modalBodyContent');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCloseBtnFooter = document.getElementById('modalCloseBtnFooter');
    const modalEditBtn = document.getElementById('modalEditBtn');

    // --- CLAVES PARA LOCALSTORAGE ---
    const STORAGE_KEYS = { 
        AUDITS: 'sgsst_audits_data_vFINALFIX', 
        TEMPLATES: 'sgsst_templates_data_vFINALFIX',
        RISKS: 'sgsst_risks_data_vFINALFIX', 
        AUDITOR_LIDER: 'sgsst_auditor_lider_vFINALFIX',
        HALLAZGOS: 'sgsst_hallazgos_data_vFINALFIX',
        ACCIONES_CORRECTIVAS: 'sgsst_acciones_correctivas_vFINALFIX',
        ACTAS_APERTURA: 'sgsst_actas_apertura_vFINALFIX',
        ACTAS_CIERRE: 'sgsst_actas_cierre_vFINALFIX'
    };

    // --- FUNCIONES AUXILIARES DE DATOS ---
    function loadData(key, defaultValue) { 
        const storedData = localStorage.getItem(key);
        // Crear copia profunda para evitar modificar el default original al usar arrays/objetos
        let defaultCopy = defaultValue;
        if (Array.isArray(defaultValue)) {
            defaultCopy = JSON.parse(JSON.stringify(defaultValue));
        } else if (typeof defaultValue === 'object' && defaultValue !== null) {
            defaultCopy = JSON.parse(JSON.stringify(defaultValue));
        }

        try { return storedData ? JSON.parse(storedData) : defaultCopy; }
        catch (e) { console.warn(`Error al parsear datos de localStorage para "${key}", usando default. Error: ${e.message}`); return defaultCopy; }
    }
    function saveData(key, data) { 
        try { localStorage.setItem(key, JSON.stringify(data)); }
        catch (e) { console.error(`Error al guardar datos en localStorage para "${key}":`, e); }
    }

    // --- DATOS INICIALES Y CARGA DESDE LOCALSTORAGE ---
    let auditorLiderActual = loadData(STORAGE_KEYS.AUDITOR_LIDER, "Equipo Auditoría SST (AuditSafety)");

    let auditsData = loadData(STORAGE_KEYS.AUDITS, [
        // ... (Mismos datos de ejemplo que en la respuesta anterior) ...
        { id: 'AUD-2025001', proyecto: 'Torre Empresarial Quantum', fechaProgramada: '2025-06-01', fechaEjecucion: '2025-06-03', responsableCliente: 'Ing. Sofia Contreras', auditorLider: auditorLiderActual, tipoAuditoriaText: 'Auditoría Interna SG-SST', plantillaIdUsada: 'TPL-DEC1072', estado: 'Finalizada', cumplimiento: '92', riesgoGeneral: 'Bajo', observacionesGenerales: 'Excelente manejo documental. Se sugiere mejorar la difusión del plan de emergencias en pisos superiores.', hallazgosIds: ['H-001', 'H-002'], accionesCorrectivasIds:['AC-001'], actaAperturaId: 'AAP-001', actaCierreId: 'ACI-001', checklistResult:[] },
        { id: 'AUD-2025002', proyecto: 'Residencial Montes Claros Et. II', fechaProgramada: '2025-06-08', fechaEjecucion: null, responsableCliente: 'Arq. Ricardo Méndez', auditorLider: auditorLiderActual, tipoAuditoriaText: 'Seguimiento Decreto 1072', plantillaIdUsada: 'TPL-DEC1072', estado: 'En Progreso', cumplimiento: null, riesgoGeneral: 'Medio', observacionesGenerales: 'Revisión de capacitación y EPP alturas.', hallazgosIds: [], accionesCorrectivasIds:[], actaAperturaId: 'AAP-002', actaCierreId: null, checklistResult:[] },
        { id: 'AUD-2025003', proyecto: 'Vía Conexión Oriente Tramo 3B', fechaProgramada: '2025-06-20', fechaEjecucion: null, responsableCliente: 'Jefe Obra Luis Patiño', auditorLider: auditorLiderActual, tipoAuditoriaText: 'Inspección Maquinaria y Equipos', plantillaIdUsada: 'TPL-MAQUINARIA', estado: 'Pendiente', cumplimiento: null, riesgoGeneral: 'Alto', observacionesGenerales: 'Foco en mantenimientos y certificación de operadores.', hallazgosIds: [], accionesCorrectivasIds:[], actaAperturaId: null, actaCierreId: null, checklistResult:[] },
    ]);

    let templatesData = loadData(STORAGE_KEYS.TEMPLATES, [
        // ... (Mismos datos de ejemplo, asegurando que checklistItems exista) ...
        { id: 'TPL-DEC1072', nombre: 'Auditoría General Decreto 1072', baseNormativa: 'Dec. 1072/2015', version: '3.1', ultimaModificacion: '2025-05-10', itemsCount: 5, descripcion: 'Plantilla completa para SG-SST.', 
            checklistItems: [
                {id:'DEC1.1.1', seccion:'I. Política', numeral: '1.1', requisito:'La Política de SST está establecida por escrito, es específica y apropiada para la empresa.', tipo:'Documental'},
                {id:'DEC1.1.2', seccion:'I. Política', numeral: '1.2', requisito:'Es concisa, clara, fechada y firmada por el representante legal.', tipo:'Documental'},
                {id:'DEC2.1.1', seccion:'II. Organización', numeral: '2.1', requisito:'Se han asignado responsabilidades específicas en SST a todos los niveles.', tipo:'Documental/Entrevista'},
                {id:'DEC3.1.1', seccion:'III. Planificación', numeral: '3.1', requisito:'Existe una identificación de peligros, evaluación y valoración de riesgos actualizada (Matriz de Riesgos).', tipo:'Documental/Verificación'},
                {id:'DEC4.1.1', seccion:'IV. Aplicación', numeral: '4.1', requisito:'Se implementan las medidas de prevención y control con base en la identificación de peligros.', tipo:'Verificación/Inspección'},
            ] 
        },
        { id: 'TPL-ALTURAS', nombre: 'Trabajo Seguro en Alturas', baseNormativa: 'Res. 4272/2021', version: '1.6', ultimaModificacion: '2025-04-20', itemsCount: 3, descripcion: 'Verificación para trabajos en alturas.', 
            checklistItems:[
                {id:'ALT1.1', seccion:'Permisos', requisito:'Se diligencia permiso de trabajo en alturas antes de iniciar labor.', tipo:'Documental'},
                {id:'ALT1.2', seccion:'EPP', requisito:'Los sistemas de protección contra caídas son inspeccionados y certificados.', tipo:'Verificación'},
                {id:'ALT1.3', seccion:'Capacitación', requisito:'Personal cuenta con curso de alturas vigente.', tipo:'Documental'},
            ]
        },
        { id: 'TPL-MAQUINARIA', nombre: 'Inspección Maquinaria', baseNormativa: 'Interna / ANSI B30', version: '2.1', ultimaModificacion: '2025-03-01', itemsCount: 2, descripcion: 'Checklist para maquinaria pesada.', 
            checklistItems:[
                {id:'MAQ1.1', seccion:'Preoperacional', requisito:'Se realiza inspección preoperacional diaria de la maquinaria.', tipo:'Documental/Verificación'},
                {id:'MAQ1.2', seccion:'Operador', requisito:'Operador cuenta con certificación vigente para el equipo.', tipo:'Documental'},
            ]
        },
    ]);
    
    let hallazgosData = loadData(STORAGE_KEYS.HALLAZGOS, [
        // ... (Mismos datos de ejemplo) ...
        {id: 'H-001', auditId:'AUD-2025001', itemId: 'DEC2.1.1', tipo: 'Observación', descripcion: 'Plan de emergencias no visible en piso 3.', norma: 'Dec. 1072 Art. 2.2.4.6.25', evidencia: 'Fotografía', riesgo:'Bajo', accionRecomendada: 'Ubicar copia del plan en cartelera informativa piso 3.'},
        {id: 'H-002', auditId:'AUD-2025001', itemId: 'DEC4.1.1', tipo: 'No Conformidad Menor', descripcion: 'Algunos EPP de alturas próximos a vencer.', norma: 'Res. 4272/2021 Art. X', evidencia: 'Inspección visual de arneses', riesgo:'Medio', accionRecomendada: 'Programar reemplazo de EPP.'}
    ]);

    let accionesCorrectivasData = loadData(STORAGE_KEYS.ACCIONES_CORRECTIVAS, [
        // ... (Mismos datos de ejemplo) ...
        {id: 'AC-001', hallazgoId:'H-002', auditId:'AUD-2025001', descripcion: 'Reemplazar 3 arneses.', responsableAccion: 'Almacén SST', fechaPropuestaCierre: '2025-06-15', fechaCierreEfectiva: null, estadoAccion: 'Abierta', seguimiento: 'Pendiente cotización.'}
    ]);

    let actasAperturaData = loadData(STORAGE_KEYS.ACTAS_APERTURA, [ /* ... (datos de ejemplo) ... */ ]);
    let actasCierreData = loadData(STORAGE_KEYS.ACTAS_CIERRE, [ /* ... (datos de ejemplo) ... */ ]);


    // --- FUNCIONES AUXILIARES ---
    // ... (getRiskLevelClass, getStatusClass, formatDate - sin cambios) ...
    function getRiskLevelClass(level) { if (!level) return ''; const l = String(level).toLowerCase(); if(l.includes('alto') || l.includes('crítico')) return 'risk-high'; if(l.includes('medio')) return 'risk-medium'; if(l.includes('bajo')) return 'risk-low'; return ''; }
    function getStatusClass(status) { if (!status) return ''; const l = status.toLowerCase(); if(l === 'finalizada') return 'status-cumple'; if(l.includes('requiere') || l.includes('revisión') || l.includes('no conforme')) return 'status-no-cumple'; if(l === 'pendiente') return 'status-pendiente'; if(l.includes('en progreso')) return 'status-en-progreso'; return ''; }
    function formatDate(dateString) { if(!dateString) return 'N/A'; try { const date = new Date(dateString.includes('T') ? dateString : dateString + 'T00:00:00-05:00'); return date.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' }); } catch(e) { return dateString; } }
    let chartInstances = {};

    // --- MODAL ---
    // ... (openAuditDetailModal, closeAuditDetailModal, y sus listeners - sin cambios significativos, solo asegurar que se llame desde el ojito) ...
    function openAuditDetailModal(audit) {
        if (!audit || !auditDetailModal) return;
        modalTitle.textContent = `Detalle Auditoría: ${audit.id}`;
        const plantillaUsada = audit.plantillaIdUsada && audit.plantillaIdUsada !== 'OTRO_ESPECIFICO' ? templatesData.find(t => t.id === audit.plantillaIdUsada) : null;
        modalBodyContent.innerHTML = `
            <h4>Proyecto: ${audit.proyecto}</h4>
            <div class="detail-grid">
                <p><strong>Fecha Ejecución:</strong> ${audit.fechaEjecucion ? formatDate(audit.fechaEjecucion) : formatDate(audit.fechaProgramada) + ' (Programada)'}</p>
                <p><strong>Responsable Cliente:</strong> ${audit.responsableCliente}</p>
                <p><strong>Tipo/Plantilla:</strong> ${plantillaUsada ? plantillaUsada.nombre : (audit.tipoAuditoriaText || 'N/E')}</p>
                <p><strong>Auditor Líder:</strong> ${audit.auditorLider}</p>
                <p><strong>Estado:</strong> <span class="status-badge ${getStatusClass(audit.estado)}">${audit.estado}</span></p>
                <p><strong>% Cumplimiento:</strong> ${audit.cumplimiento ? audit.cumplimiento + '%' : 'N/A'}</p>
                <p><strong>Riesgo General:</strong> <span class="risk-level ${getRiskLevelClass(audit.riesgoGeneral)}">${audit.riesgoGeneral || 'N/A'}</span></p>
                ${audit.normaAdicional ? `<p><strong>Norma Adicional:</strong> ${audit.normaAdicional}</p>` : ''}
            </div>
            <p><strong>Observaciones Generales / Alcance:</strong></p>
            <p style="white-space: pre-wrap; background-color: #f8f9fa; padding:10px; border-radius:var(--border-radius); font-size:0.9rem;">${audit.observacionesGenerales || 'No registradas.'}</p>
            <div style="margin-top:15px;"><strong>Hallazgos Registrados:</strong> ${audit.hallazgosIds?.length || 0}</div>
        `;
        modalEditBtn.style.display = audit.estado !== 'Finalizada' ? 'inline-flex' : 'none';
        modalEditBtn.dataset.auditId = audit.id;
        modalEditBtn.onclick = () => {
            closeAuditDetailModal();
            window.loadContent('ejecutarAuditoria', `Ejecutar Auditoría: ${audit.id}`, audit); 
        };
        auditDetailModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
    function closeAuditDetailModal() { if(!auditDetailModal) return; auditDetailModal.style.display = 'none'; document.body.style.overflow = '';}
    if(modalCloseBtn) modalCloseBtn.addEventListener('click', closeAuditDetailModal);
    if(modalCloseBtnFooter) modalCloseBtnFooter.addEventListener('click', closeAuditDetailModal);
    auditDetailModal?.addEventListener('click', function(event) { if (event.target === auditDetailModal) closeAuditDetailModal(); });

    // --- RENDERIZADO DE TABLAS ---
    // ... (renderAuditsTable, renderTemplatesTable, renderRisksTable - sin cambios significativos, solo asegurar que el ojito llame a openAuditDetailModal) ...
    function renderAuditsTable(targetTableId, filterFn = () => true) {
        const tableBody = document.getElementById(targetTableId)?.querySelector('tbody');
        if (!tableBody) { console.warn(`Tabla con ID ${targetTableId} no encontrada.`); return; }
        const filteredAudits = auditsData.filter(filterFn).sort((a,b) => new Date(b.fechaProgramada) - new Date(a.fechaProgramada));
        tableBody.innerHTML = filteredAudits.length > 0 ? filteredAudits.map(audit => `
            <tr data-audit-id="${audit.id}" title="Ver detalle de ${audit.id}">
                <td>${audit.id}</td>
                <td>${audit.proyecto}</td>
                <td>${formatDate(audit.fechaProgramada)}</td>
                <td>${audit.responsableCliente}</td>
                <td><span class="status-badge ${getStatusClass(audit.estado)}">${audit.estado}</span></td>
                <td>${audit.cumplimiento ? audit.cumplimiento + '%' : 'N/A'}</td>
                <td><span class="risk-level ${getRiskLevelClass(audit.riesgoGeneral)}">${audit.riesgoGeneral || 'N/A'}</span></td>
                <td><a href="#" class="action-icon view-audit-detail" data-audit-id="${audit.id}" title="Ver Detalles (Modal)"><i class="fas fa-eye"></i></a></td>
            </tr>`).join('') : `<tr><td colspan="8" style="text-align:center; padding: 20px;">No hay auditorías que mostrar.</td></tr>`;
        
        tableBody.querySelectorAll('a.view-audit-detail').forEach(icon => {
            icon.addEventListener('click', function(event) {
                event.preventDefault(); event.stopPropagation();
                const auditId = this.dataset.auditId;
                const auditDetail = auditsData.find(a => a.id === auditId);
                if (auditDetail) openAuditDetailModal(auditDetail);
            });
        });
    }
    function renderTemplatesTable() { 
        const tableBody = document.getElementById('templatesTable')?.querySelector('tbody');
        if (!tableBody) return;
        tableBody.innerHTML = templatesData.map(tpl => `
            <tr>
                <td><strong>${tpl.nombre}</strong><br><small style="color:var(--color-text-light);">${tpl.descripcion || ''}</small></td>
                <td>${tpl.baseNormativa}</td><td>${tpl.version}</td>
                <td>${formatDate(tpl.ultimaModificacion)}</td><td>${tpl.itemsCount || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" title="Usar ${tpl.nombre} para nueva auditoría" onclick="window.location.hash='#nuevaAuditoria'; setTimeout(() => { if(document.getElementById('auditPlantilla')) document.getElementById('auditPlantilla').value = '${tpl.id}';},100);"><i class="fas fa-play-circle"></i> Usar</button>
                    <a href="#" class="action-icon" title="Editar ${tpl.nombre}"><i class="fas fa-edit"></i></a>
                </td>
            </tr>`).join('');
    }
    function renderRisksTable() {
        const tableBody = document.getElementById('risksTable')?.querySelector('tbody');
        if(!tableBody) return;
        tableBody.innerHTML = risksData.map(risk => `
            <tr title="Fuente: ${risk.fuente || 'N/A'} | Peligro: ${risk.factorRiesgo || 'N/A'}">
                <td>${risk.id}</td>
                <td>${risk.identificacion}</td>
                <td>${risk.areaProceso}</td>
                <td><span class="risk-level ${getRiskLevelClass(risk.nivelIntervenido || risk.nivelPuro)}">${risk.nivelIntervenido || risk.nivelPuro}</span></td>
                <td style="max-width:300px; white-space:normal;">${risk.controlesPropuestos || risk.controlesExistentes}</td>
                <td><a href="#" class="action-icon" title="Ver/Editar Matriz de Riesgo ${risk.id}"><i class="fas fa-tasks"></i></a></td>
            </tr>`).join('');
    }
    function renderHallazgosTable(targetTableId, filterFn = () => true) {
        const tableBody = document.getElementById(targetTableId)?.querySelector('tbody');
        if (!tableBody) { console.warn(`Tabla con ID ${targetTableId} no encontrada.`); return; }
        const filteredHallazgos = hallazgosData.filter(filterFn).sort((a,b) => (b.auditId || "").localeCompare(a.auditId || ""));
        tableBody.innerHTML = filteredHallazgos.length > 0 ? filteredHallazgos.map(h => `
            <tr>
                <td>${h.id}</td>
                <td><a href="#detalleAuditoria" class="nav-trigger" data-audit-id="${h.auditId}">${h.auditId}</a></td>
                <td>${h.tipo}</td>
                <td style="max-width:300px; white-space:normal;">${h.descripcion}</td>
                <td><span class="risk-level ${getRiskLevelClass(h.riesgo)}">${h.riesgo || 'N/A'}</span></td>
                <td>${accionesCorrectivasData.find(ac => ac.hallazgoId === h.id)?.estadoAccion || 'Pendiente'}</td>
                <td><a href="#" class="action-icon" title="Gestionar Acción Correctiva"><i class="fas fa-cogs"></i></a></td>
            </tr>`).join('') : `<tr><td colspan="7" style="text-align:center; padding: 20px;">No hay hallazgos que mostrar.</td></tr>`;
        
        // Add listeners to auditId links if needed to load detail page
        tableBody.querySelectorAll('a.nav-trigger[data-audit-id]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const auditToLoad = auditsData.find(a => a.id === link.dataset.auditId);
                if (auditToLoad) window.loadContent('detalleAuditoria', `Detalle Auditoría: ${auditToLoad.id}`, auditToLoad);
            });
        });
    }
     function renderAccionesCorrectivasTable(targetTableId, filterFn = () => true) {
        const tableBody = document.getElementById(targetTableId)?.querySelector('tbody');
        if (!tableBody) { console.warn(`Tabla con ID ${targetTableId} no encontrada.`); return; }
        const filteredAcciones = accionesCorrectivasData.filter(filterFn).sort((a,b) => new Date(b.fechaPropuestaCierre) - new Date(a.fechaPropuestaCierre));
        tableBody.innerHTML = filteredAcciones.length > 0 ? filteredAcciones.map(ac => `
            <tr>
                <td>${ac.id}</td>
                <td>${ac.auditId} / ${ac.hallazgoId}</td>
                <td style="max-width:300px; white-space:normal;">${ac.descripcion}</td>
                <td>${ac.responsableAccion}</td>
                <td>${formatDate(ac.fechaPropuestaCierre)}</td>
                <td><span class="status-badge ${getStatusClass(ac.estadoAccion)}">${ac.estadoAccion}</span></td>
                <td><a href="#" class="action-icon" title="Actualizar Acción"><i class="fas fa-edit"></i></a></td>
            </tr>`).join('') : `<tr><td colspan="7" style="text-align:center; padding: 20px;">No hay acciones correctivas que mostrar.</td></tr>`;
    }


    // --- GRÁFICAS ---
    // ... (destroyChart, renderAuditStatusChart, renderRiskLevelChart, renderAuditsOverTimeChart - sin cambios, pero asegurar que los IDs de canvas existan en el HTML de `pageContents.dashboard`) ...
    function destroyChart(chartId) { if (chartInstances[chartId]) { chartInstances[chartId].destroy(); delete chartInstances[chartId]; } }
    function renderAuditStatusChart() { 
        const chartId = 'auditStatusChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        const statusCounts = auditsData.reduce((acc, audit) => { acc[audit.estado] = (acc[audit.estado] || 0) + 1; return acc; }, {});
        chartInstances[chartId] = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-info').trim()], hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{padding:15,boxWidth:12,font:{size:11}} }}}});
    }
    function renderRiskLevelChart() { 
        const chartId = 'riskLevelChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        const riskCounts = auditsData.reduce((acc, audit) => { const risk = audit.riesgoGeneral || 'N/D'; acc[risk] = (acc[risk] || 0) + 1; return acc; }, {});
        chartInstances[chartId] = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(riskCounts), datasets: [{ label: 'Auditorías', data: Object.values(riskCounts), backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-text-light').trim()] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }});
    }
    function renderAuditsOverTimeChart() { 
        const chartId = 'auditsOverTimeChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const today = new Date(); const labels = []; const dataCompleted = []; const dataCreated = [];
        for (let i = 5; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            labels.push(monthNames[date.getMonth()] + ' ' + date.getFullYear().toString().slice(-2));
            const monthAuditsCreated = auditsData.filter(a => new Date(a.fechaProgramada).getFullYear() === date.getFullYear() && new Date(a.fechaProgramada).getMonth() === date.getMonth()).length;
            const monthAuditsCompleted = auditsData.filter(a => a.fechaEjecucion && new Date(a.fechaEjecucion).getFullYear() === date.getFullYear() && new Date(a.fechaEjecucion).getMonth() === date.getMonth() && a.estado === 'Finalizada').length;
            dataCreated.push(monthAuditsCreated + Math.floor(Math.random() * 2)); // + un poco de random para simular más actividad
            dataCompleted.push(monthAuditsCompleted);
        }
        chartInstances[chartId] = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: 'Programadas', data: dataCreated, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim(), tension: 0.3, fill: false }, { label: 'Finalizadas', data: dataCompleted, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim(), tension: 0.3, fill: false } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }}, scales: { y: { beginAtZero: true, ticks:{stepSize:1} } } } });
    }
    function renderHallazgosPorTipoChart() { /* ... (Misma lógica que antes) ... */
        const chartId = 'hallazgosPorTipoChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        const tipoCounts = hallazgosData.reduce((acc, h) => { acc[h.tipo] = (acc[h.tipo] || 0) + 1; return acc; }, {});
        chartInstances[chartId] = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(tipoCounts), datasets: [{ data: Object.values(tipoCounts), backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-info').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-text-light').trim()] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }}}});
    }
    function renderAccionesCorrectivasChart() { /* ... (Misma lógica que antes) ... */
        const chartId = 'accionesCorrectivasChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        const estadoCounts = accionesCorrectivasData.reduce((acc, ac) => { acc[ac.estadoAccion] = (acc[ac.estadoAccion] || 0) + 1; return acc; }, {});
        chartInstances[chartId] = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(estadoCounts), datasets: [{ label: 'Estado', data: Object.values(estadoCounts), backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-success').trim(), getComputedStyle(document.documentElement).getPropertyValue('--color-warning').trim()] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}, scales:{y:{beginAtZero:true, ticks:{stepSize:1}}}} });
    }
    function renderCumplimientoPorNormaChart() { /* ... (Misma lógica que antes) ... */
        const chartId = 'cumplimientoPorNormaChart'; destroyChart(chartId);
        const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return;
        new Chart(ctx, { type: 'radar', data: { labels: ['Dec. 1072', 'Res. 4272', 'Res. 0491', 'ISO 45001', 'Interna'], datasets: [{ label: '% Cumplimiento Promedio', data: [85,92,78,95,88], borderColor: 'rgba(0,123,255,0.8)', backgroundColor: 'rgba(0,123,255,0.2)'}] }, options: { responsive: true, maintainAspectRatio: false, scales:{r:{angleLines:{display:true}, suggestedMin:0, suggestedMax:100, pointLabels:{font:{size:10}}}} }});
    }


    // --- CONTENIDO DE LAS PÁGINAS (FUNCIONES QUE DEVUELVEN HTML) ---
    // ... (pageContents y pageContentsDefault - asegurar que los canvas tengan los IDs correctos y estén dentro de .chart-canvas-wrapper) ...
    // ... (Voy a pegar solo la estructura de pageContents.dashboard, el resto son como en la respuesta anterior) ...
    const pageContents = {
        dashboard: function() { /* ... (HTML con canvas y IDs correctos) ... */
            // ... (cálculos de avgCompliance, etc. igual que antes) ...
            const totalAudits = auditsData.length;
            const completedAudits = auditsData.filter(a => a.estado === 'Finalizada');
            const highRiskAudits = auditsData.filter(a => a.riesgoGeneral && a.riesgoGeneral.toLowerCase().includes('alto')).length;
            let avgCompliance = 0;
            if (completedAudits.length > 0) {
                const validComplianceAudits = completedAudits.filter(a => !isNaN(parseFloat(a.cumplimiento)));
                if (validComplianceAudits.length > 0) {
                     avgCompliance = Math.round(validComplianceAudits.reduce((sum, a) => sum + parseFloat(a.cumplimiento), 0) / validComplianceAudits.length);
                }
            }
            return `
                <section class="summary-cards">
                    <div class="summary-card cumple"><div class="summary-card-content"><div class="summary-card-info"><h3>Cumplimiento Prom.</h3><span class="value">${avgCompliance}%</span></div><div class="summary-card-icon"><i class="fas fa-shield-alt"></i></div></div></div>
                    <div class="summary-card no-cumple"><div class="summary-card-content"><div class="summary-card-info"><h3>Auditorías Alto Riesgo</h3><span class="value">${highRiskAudits}</span></div><div class="summary-card-icon"><i class="fas fa-exclamation-triangle"></i></div></div></div>
                    <div class="summary-card info"><div class="summary-card-content"><div class="summary-card-info"><h3>Auditorías Totales</h3><span class="value">${totalAudits}</span></div><div class="summary-card-icon"><i class="fas fa-calendar-check"></i></div></div></div>
                    <div class="summary-card observacion"><div class="summary-card-content"><div class="summary-card-info"><h3>Plantillas SG-SST</h3><span class="value">${templatesData.length}</span></div><div class="summary-card-icon"><i class="fas fa-list-alt"></i></div></div></div>
                </section>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom:25px;" class="charts-row-1">
                    <div class="chart-outer-container"><h3>Estado General de Auditorías</h3><div class="chart-canvas-wrapper"><canvas id="auditStatusChart"></canvas></div></div>
                    <div class="chart-outer-container"><h3>Auditorías por Nivel de Riesgo</h3><div class="chart-canvas-wrapper"><canvas id="riskLevelChart"></canvas></div></div>
                </div>
                <div class="chart-outer-container" style="margin-bottom:25px;">
                    <h3>Auditorías Programadas/Finalizadas (Últimos 6 Meses - Simulado)</h3>
                    <div class="chart-canvas-wrapper line-chart"><canvas id="auditsOverTimeChart"></canvas></div>
                </div>
                <section class="custom-card">
                    <div class="custom-card-header"><h2>Auditorías Recientes y Próximas</h2><a href="#historialAuditorias" class="btn btn-sm btn-outline-primary nav-trigger" data-page-name="Historial de Auditorías">Ver Todas</a></div>
                    <table class="data-table" id="dashboardAuditsTable">
                        <thead><tr><th>ID</th><th>Proyecto</th><th>Fecha Prog.</th><th>Responsable</th><th>Estado</th><th>Riesgo</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </section>
            `;
        },
        // ... (El resto de las funciones de pageContents y pageContentsDefault como en la respuesta anterior, 
        //      asegurando que los IDs de canvas para la página de reportes estén correctos si los defines ahí)
        //      Por ejemplo, en pageContents.reportesGraficas:
        //      <div class="chart-outer-container"><h3>Hallazgos por Tipo</h3><div class="chart-canvas-wrapper"><canvas id="hallazgosPorTipoChart"></canvas></div></div>
        //      ...etc.
        //      Voy a pegar el objeto pageContentsDefault completo como referencia de la estructura que debe mantenerse.
         nuevaAuditoria: function() { return pageContentsDefault.nuevaAuditoria(); },
        ejecutarAuditoria: function(auditToExecute) { return pageContentsDefault.ejecutarAuditoria(auditToExecute); },
        auditoriasActivas: function() { return pageContentsDefault.auditoriasActivas(); },
        historialAuditorias: function() { return pageContentsDefault.historialAuditorias(); },
        actaApertura: function(auditContext) { return pageContentsDefault.actaApertura(auditContext); },
        actaCierre: function() { return pageContentsDefault.actaCierre(); },
        informeHallazgos: function() { return pageContentsDefault.informeHallazgos(); },
        informeFinal: function() { return pageContentsDefault.informeFinal(); },
        gestionarPlantillas: function() { return pageContentsDefault.gestionarPlantillas(); },
        gestionHallazgos: function() { return pageContentsDefault.gestionHallazgos(); },
        accionesCorrectivas: function() { return pageContentsDefault.accionesCorrectivas(); },
        clasificacionRiesgos: function() { return pageContentsDefault.clasificacionRiesgos(); },
        normativa: function() { return pageContentsDefault.normativa(); },
        reportesGraficas: function() { return pageContentsDefault.reportesGraficas(); },
        alertasNotificaciones: function() { return pageContentsDefault.alertasNotificaciones(); },
        configuracion: function() { return pageContentsDefault.configuracion(); },
        detalleAuditoria: function(audit) { return pageContentsDefault.detalleAuditoria(audit); }
    };
    const pageContentsDefault = { /* ... (Todas las funciones de pageContents de la respuesta anterior aquí, sin cambios en su HTML interno) ... */
        nuevaAuditoria: function() {
            return `
                <section class="custom-card">
                    <div class="custom-card-header"><h2>Programar Nueva Auditoría SG-SST</h2></div>
                    <form id="formNuevaAuditoria">
                        <div class="form-grid">
                            <div class="form-group"><label for="auditNombreProyecto">Nombre del Proyecto/Empresa Contratista *</label><input type="text" id="auditNombreProyecto" required></div>
                            <div class="form-group"><label for="auditFechaProgramada">Fecha Programada Auditoría *</label><input type="date" id="auditFechaProgramada" required value="${new Date().toISOString().split('T')[0]}"></div>
                            <div class="form-group"><label for="auditResponsableCliente">Responsable Cliente/Encargado Proyecto *</label><input type="text" id="auditResponsableCliente" required></div>
                            <div class="form-group"><label for="auditAuditorLider">Auditor Líder Asignado</label><input type="text" id="auditAuditorLider" value="${auditorLiderActual}" readonly></div>
                            <div class="form-group"><label for="auditPlantilla">Usar Plantilla Base (Checklist)</label><select id="auditPlantilla">${templatesData.map(t => `<option value="${t.id}" data-template-name="${t.nombre}">${t.nombre} (${t.baseNormativa})</option>`).join('')}<option value="OTRO_ESPECIFICO">Otra Específica (Sin plantilla base)</option></select></div>
                            <div class="form-group"><label for="auditNormaReferencia">Norma(s) de Referencia Adicional</label><input type="text" id="auditNormaReferencia" placeholder="Ej: ISO 45001, Guía RUC"></div>
                        </div>
                        <div class="form-group"><label for="auditAlcance">Alcance y Objetivos de la Auditoría</label><textarea id="auditAlcance" rows="4" placeholder="Describa los procesos, áreas a auditar y los objetivos específicos..."></textarea></div>
                        <div class="form-actions"> <button type="submit" class="btn btn-primary"><i class="fas fa-calendar-check"></i> Programar Auditoría</button> </div>
                    </form>
                    <div id="nuevaAuditoriaMessage" style="display:none; margin-top:20px;"></div>
                </section>
            `;
        },
        ejecutarAuditoria: function(auditToExecute) { 
            if (!auditToExecute) {
                 const pendingAudits = auditsData.filter(a => a.estado === 'Pendiente' || a.estado === 'En Progreso');
                 return `<section class="custom-card"><div class="custom-card-header"><h2>Seleccionar Auditoría para Ejecutar</h2></div> ${pendingAudits.length > 0 ? `<div class="form-group"><label for="selectAuditToExecute">Auditorías Pendientes o En Progreso:</label><select id="selectAuditToExecute" class="form-control"><option value="">-- Seleccione una auditoría --</option>${pendingAudits.map(a => `<option value="${a.id}">${a.id} - ${a.proyecto}</option>`).join('')}</select></div><button class="btn btn-primary" id="btnLoadAuditForExecution">Cargar Auditoría</button>` : `<p class="info-message">No hay auditorías pendientes o en progreso para ejecutar.</p>`}</section>`;
            }
            const plantilla = templatesData.find(t => t.id === auditToExecute.plantillaIdUsada);
            let checklistHTML = '<p class="info-message">No hay un checklist detallado para esta plantilla o es una auditoría específica.</p>';
            if (plantilla && plantilla.checklistItems && plantilla.checklistItems.length > 0) {
                checklistHTML = plantilla.checklistItems.map((item, index) => `
                    <div class="checklist-item" data-item-id="${item.id}">
                        <div class="checklist-item-header">${index + 1}. ${item.seccion} - ${item.numeral || ''}</div>
                        <p class="checklist-item-criteria"><strong>Requisito:</strong> ${item.requisito}</p>
                        <p class="checklist-item-criteria"><small><strong>Criterio de Verificación:</strong> ${item.criterio || 'N/A'}</small></p>
                        <div class="checklist-qualification">
                            <label><input type="radio" name="qual_${item.id}" value="Cumple"> Cumple</label>
                            <label><input type="radio" name="qual_${item.id}" value="No Cumple"> No Cumple</label>
                            <label><input type="radio" name="qual_${item.id}" value="No Aplica"> No Aplica</label>
                            <label><input type="radio" name="qual_${item.id}" value="Observacion"> Observación</label>
                        </div>
                        <div class="checklist-observacion-area">
                            <textarea placeholder="Observaciones / Evidencia para este ítem..."></textarea>
                        </div>
                    </div>
                `).join('');
            }

            return `<section class="custom-card"><div class="custom-card-header"><h2>Ejecutando Auditoría: ${auditToExecute.id} - ${auditToExecute.proyecto}</h2></div>
                <p><strong>Plantilla Base:</strong> ${plantilla ? plantilla.nombre : 'Específica'}</p>
                <p><strong>Fecha Programada:</strong> ${formatDate(auditToExecute.fechaProgramada)}</p>
                
                <h3 style="margin-top:20px; margin-bottom:10px;">Checklist de Auditoría:</h3>
                <div id="checklistContainer">${checklistHTML}</div>
                
                <h3 style="margin-top:30px;">Registrar Nuevo Hallazgo General</h3> 
                <form id="formNuevoHallazgo" data-audit-id="${auditToExecute.id}"><div class="form-group"><label for="hallazgoTipo">Tipo:</label><select id="hallazgoTipo"><option>No Conformidad Mayor</option><option>No Conformidad Menor</option><option>Observación</option><option>Oportunidad de Mejora</option></select></div><div class="form-group"><label for="hallazgoDescripcion">Descripción:</label><textarea id="hallazgoDescripcion" rows="3" required></textarea></div><div class="form-group"><label for="hallazgoNorma">Norma Incumplida:</label><input type="text" id="hallazgoNorma"></div><div class="form-actions"><button type="submit" class="btn btn-accent"><i class="fas fa-plus-circle"></i> Agregar Hallazgo General</button></div></form> <div id="nuevoHallazgoMessage" style="display:none; margin-top:15px;"></div>
                <h3 style="margin-top:30px;">Hallazgos Registrados:</h3> <div id="hallazgosListForAudit"></div>

                <div class="custom-card-header" style="margin-top:30px;"><h3>Finalización de Auditoría</h3></div>
                <div class="form-grid">
                    <div class="form-group"><label for="auditEjecucionFecha">Fecha de Ejecución/Finalización *</label><input type="date" id="auditEjecucionFecha" value="${auditToExecute.fechaEjecucion || new Date().toISOString().split('T')[0]}" required></div>
                    <div class="form-group"><label for="auditCumplimientoPct">% Cumplimiento General *</label><input type="number" id="auditCumplimientoPct" min="0" max="100" placeholder="Ej: 85" value="${auditToExecute.cumplimiento || ''}" required></div>
                    <div class="form-group"><label for="auditRiesgoGeneral">Nivel de Riesgo General de la Auditoría *</label><select id="auditRiesgoGeneral" required><option value="">-- Seleccione --</option><option value="Bajo" ${auditToExecute.riesgoGeneral === 'Bajo' ? 'selected' : ''}>Bajo</option><option value="Medio" ${auditToExecute.riesgoGeneral === 'Medio' ? 'selected' : ''}>Medio</option><option value="Alto" ${auditToExecute.riesgoGeneral === 'Alto' ? 'selected' : ''}>Alto</option><option value="Crítico" ${auditToExecute.riesgoGeneral === 'Crítico' ? 'selected' : ''}>Crítico</option></select></div>
                </div>
                <div class="form-group"><label for="auditResumenEjecutivo">Resumen Ejecutivo / Conclusiones Generales</label><textarea id="auditResumenEjecutivo" rows="4" placeholder="Principales conclusiones y resumen de la auditoría...">${auditToExecute.observacionesGenerales || ''}</textarea></div>

                <div class="form-actions" style="margin-top:30px;"><button class="btn btn-success" data-audit-id="${auditToExecute.id}" id="btnFinalizarEjecucion"><i class="fas fa-check-square"></i> Guardar y Finalizar Ejecución</button></div></section>`;
        },
        auditoriasActivas: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Auditorías Activas</h2></div><table class="data-table" id="activeAuditsTable"><thead><tr><th>ID</th><th>Proyecto</th><th>Fecha Prog.</th><th>Responsable</th><th>Estado</th><th>Riesgo Est.</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`; },
        historialAuditorias: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Historial Completo</h2></div><table class="data-table" id="fullAuditsHistoryTable"><thead><tr><th>ID</th><th>Proyecto</th><th>Fecha Ejec./Prog.</th><th>Responsable</th><th>Estado</th><th>% Cumpl.</th><th>Riesgo</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`;},
        actaApertura: function(auditContext = null) { 
            const relatedAudit = auditContext || (auditsData.find(a => a.estado === 'Pendiente' || a.estado === 'En Progreso'));
            const actaExistente = relatedAudit ? actasAperturaData.find(a => a.auditId === relatedAudit.id) : null;
            return `<section class="custom-card"><div class="custom-card-header"><h2>${actaExistente ? 'Ver/Editar' : 'Registrar'} Acta de Apertura</h2></div><form id="formActaApertura"><div class="form-group"><label for="actaAuditId">Auditoría Relacionada:</label><select id="actaAuditId" required><option value="">-- Seleccione --</option>${auditsData.map(a => `<option value="${a.id}" ${relatedAudit && relatedAudit.id === a.id ? 'selected' : ''}>${a.id} - ${a.proyecto}</option>`).join('')}</select></div><div class="form-grid"><div class="form-group"><label for="actaAperturaFecha">Fecha:</label><input type="date" id="actaAperturaFecha" value="${actaExistente ? actaExistente.fecha : new Date().toISOString().split('T')[0]}" required></div><div class="form-group"><label for="actaAperturaHoraInicio">Hora Inicio:</label><input type="time" id="actaAperturaHoraInicio" value="${actaExistente ? actaExistente.horaInicio : '08:00'}" required></div></div><div class="form-group"><label for="actaAperturaLugar">Lugar:</label><input type="text" id="actaAperturaLugar" value="${actaExistente ? actaExistente.lugar : 'Sala de Juntas'}" required></div><div class="form-group"><label for="actaAperturaParticipantes">Participantes:</label><textarea id="actaAperturaParticipantes" rows="3" required>${actaExistente ? actaExistente.participantes : ''}</textarea></div><div class="form-group"><label for="actaAperturaObjetivos">Objetivos:</label><textarea id="actaAperturaObjetivos" rows="2" required>${actaExistente ? actaExistente.objetivos : (relatedAudit ? `Evaluar SG-SST para ${relatedAudit.tipoAuditoriaText}`: '')}</textarea></div><div class="form-group"><label for="actaAperturaAlcance">Alcance:</label><textarea id="actaAperturaAlcance" rows="2" required>${actaExistente ? actaExistente.alcance : (relatedAudit ? `Procesos de ${relatedAudit.proyecto}` : '')}</textarea></div><div class="form-group"><label for="actaAperturaCriterios">Criterios:</label><textarea id="actaAperturaCriterios" rows="2" required>${actaExistente ? actaExistente.criterios : 'Dec. 1072/2015'}</textarea></div><div class="form-actions"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Acta</button></div></form><div id="actaAperturaMessage" style="display:none; margin-top:15px;"></div></section>`;
        },
        actaCierre: function() { return `<section class="custom-card"><h2>Acta de Cierre</h2><p class="info-message">Formulario para acta de cierre. (Pendiente desarrollo detallado)</p></section>`; },
        informeHallazgos: function() { return `<section class="custom-card"><h2>Informe de Hallazgos</h2><p class="info-message">Generación de informe de hallazgos. (Pendiente desarrollo detallado)</p></section>`; },
        informeFinal: function() { return `<section class="custom-card"><h2>Informe Final Consolidado</h2><p class="info-message">Generación de informe final. (Pendiente desarrollo detallado)</p></section>`; },
        gestionarPlantillas: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Gestor de Plantillas y Checklists</h2><button class="btn btn-accent"><i class="fas fa-plus"></i> Nueva Plantilla</button></div><table class="data-table" id="templatesTable"><thead><tr><th>Nombre y Desc.</th><th>Base Normativa</th><th>Versión</th><th>Últ. Mod.</th><th># Items</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`;},
        gestionHallazgos: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Gestión de Hallazgos</h2> <button class="btn btn-accent"><i class="fas fa-plus"></i> Nuevo Hallazgo Manual</button> </div><table class="data-table" id="allHallazgosTable"><thead><tr><th>ID Hallazgo</th><th>ID Auditoría</th><th>Tipo</th><th>Descripción</th><th>Riesgo</th><th>Estado Acción</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`;},
        accionesCorrectivas: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Seguimiento Acciones Correctivas</h2></div><table class="data-table" id="allAccionesCorrectivasTable"><thead><tr><th>ID Acción</th><th>Auditoría/Hallazgo</th><th>Descripción Acción</th><th>Responsable</th><th>Fecha Prop. Cierre</th><th>Estado</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`;},
        clasificacionRiesgos: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Matriz de Riesgos</h2><button class="btn btn-accent"><i class="fas fa-plus"></i> Nuevo Riesgo</button></div><table class="data-table" id="risksTable"><thead><tr><th>ID</th><th>Identificación Peligro</th><th>Área</th><th>Nivel Riesgo</th><th>Controles</th><th>Acciones</th></tr></thead><tbody></tbody></table></section>`;},
        normativa: function() { return `<section class="custom-card"><h2>Normativa y Documentos</h2><p class="info-message">Repositorio de documentos. (Pendiente desarrollo)</p></section>`;},
        reportesGraficas: function() { return `<section class="custom-card"><div class="custom-card-header"><h2>Reportes y Gráficas Avanzadas</h2></div> <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;"> <div class="chart-outer-container"><h3>Hallazgos por Tipo</h3><div class="chart-canvas-wrapper"><canvas id="hallazgosPorTipoChart"></canvas></div></div> <div class="chart-outer-container"><h3>Estado Acciones Correctivas</h3><div class="chart-canvas-wrapper"><canvas id="accionesCorrectivasChart"></canvas></div></div> <div class="chart-outer-container"><h3>Cumplimiento por Norma (Sim.)</h3><div class="chart-canvas-wrapper"><canvas id="cumplimientoPorNormaChart"></canvas></div></div> </div></section>`;},
        alertasNotificaciones: function() { /* ... (Misma lógica de antes para mostrar alertas) ... */
             const overdueActions = accionesCorrectivasData.filter(ac => ac.estadoAccion !== 'Cerrada' && new Date(ac.fechaPropuestaCierre) < new Date());
             const criticalFindings = hallazgosData.filter(h => h.tipo === 'No Conformidad Mayor' && !accionesCorrectivasData.find(ac => ac.hallazgoId === h.id && ac.estadoAccion === 'Cerrada'));
            return `<section class="custom-card"><div class="custom-card-header"><h2><i class="fas fa-bell" style="color:var(--color-danger);"></i> Alertas y Pendientes Críticos</h2></div> ${overdueActions.length > 0 ? `<h3><i class="fas fa-calendar-times"></i> Acciones Correctivas Vencidas (${overdueActions.length})</h3><ul style="list-style-type:disc; margin-left:20px;">${overdueActions.map(ac => `<li>Acción: ${ac.descripcion} (Aud: ${ac.auditId}, Hall: ${ac.hallazgoId}) - Vence: ${formatDate(ac.fechaPropuestaCierre)}</li>`).join('')}</ul>` : '<p class="info-message">No hay acciones correctivas vencidas.</p>'} ${criticalFindings.length > 0 ? `<h3 style="margin-top:20px;"><i class="fas fa-exclamation-triangle"></i> No Conformidades Mayores sin Acción Cerrada (${criticalFindings.length})</h3><ul style="list-style-type:disc; margin-left:20px;">${criticalFindings.map(h => `<li>Hallazgo: ${h.descripcion} (Aud: ${h.auditId})</li>`).join('')}</ul>` : '<p class="info-message" style="margin-top:20px;">No hay NC Mayores con acciones pendientes.</p>'}</section>`;
        },
        configuracion: function() { return pageContentsDefault.configuracion(); },
        detalleAuditoria: function(audit) { return pageContentsDefault.detalleAuditoria(audit); }
    };

    // --- FUNCIÓN PRINCIPAL PARA CARGAR CONTENIDO ---
    window.loadContent = function(pageId, pageName, dataForPage = null) { /* ... (Igual que antes, pero llamará a más funciones de renderizado para las nuevas secciones) ... */
        const contentGenerator = pageContents[pageId] || pageContentsDefault[pageId];
        contentArea.innerHTML = contentGenerator ? contentGenerator(dataForPage) : `<section class="custom-card"><h2>${pageName}</h2><p class="info-message">Contenido para la sección '${pageId}' está en desarrollo.</p></section>`;
        if (pageTitleElement) pageTitleElement.textContent = pageName;

        // Actualizar clase activa en el sidebar
        document.querySelectorAll('.sidebar-nav li.active').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.sidebar-nav .submenu li.active-sub').forEach(item => item.classList.remove('active-sub'));
        const activeLink = document.querySelector(`.nav-trigger[href="#${pageId}"]`);
        if (activeLink) {
            let parentLi = activeLink.closest('li:not(.submenu li)');
            if (parentLi) parentLi.classList.add('active');
            if (activeLink.closest('.submenu')) {
                activeLink.parentElement.classList.add('active-sub');
                let mainParentLi = activeLink.closest('ul.submenu').parentElement;
                if (mainParentLi && !mainParentLi.classList.contains('open')) {
                    mainParentLi.classList.add('open');
                    const submenuElement = mainParentLi.querySelector('.submenu');
                    if(submenuElement) submenuElement.style.maxHeight = submenuElement.scrollHeight + "px";
                }
            }
        }

        // Lógica específica DESPUÉS de cargar contenido
        if (pageId === 'dashboard') {
            renderAuditsTable('dashboardAuditsTable', audit => ['En Progreso', 'Pendiente', 'Revisión'].includes(audit.estado) || auditsData.indexOf(audit) < 2);
            renderAuditStatusChart();
            renderRiskLevelChart();
            renderAuditsOverTimeChart();
        } else if (pageId === 'nuevaAuditoria') {
            attachFormNuevaAuditoriaListener();
            const auditorLiderInput = document.getElementById('auditAuditorLider');
            if (auditorLiderInput) auditorLiderInput.value = auditorLiderActual;
        } else if (pageId === 'ejecutarAuditoria') {
            if (dataForPage) { 
                attachFormNuevoHallazgoListener(dataForPage.id);
                renderHallazgosForAudit(dataForPage.id);
                attachBtnFinalizarEjecucionListener(dataForPage.id);
                attachChecklistListeners(dataForPage.id); // <- NUEVO para checklist
            } else { 
                const btnLoad = document.getElementById('btnLoadAuditForExecution');
                const selectAudit = document.getElementById('selectAuditToExecute');
                if(btnLoad && selectAudit) {
                    btnLoad.addEventListener('click', () => {
                        const selectedAuditId = selectAudit.value;
                        if(selectedAuditId) {
                            const auditToLoad = auditsData.find(a => a.id === selectedAuditId);
                            if(auditToLoad) window.loadContent('ejecutarAuditoria', `Ejecutar Auditoría: ${auditToLoad.id}`, auditToLoad);
                        } else { alert('Por favor, seleccione una auditoría.'); }
                    });
                }
            }
        }
        else if (pageId === 'auditoriasActivas') {
            renderAuditsTable('activeAuditsTable', audit => audit.estado === 'En Progreso' || audit.estado === 'Pendiente');
        } else if (pageId === 'historialAuditorias') {
            renderAuditsTable('fullAuditsHistoryTable'); 
        } else if (pageId === 'gestionarPlantillas') {
            renderTemplatesTable();
        } else if (pageId === 'clasificacionRiesgos') {
            renderRisksTable();
        } else if (pageId === 'configuracion') {
            loadConfiguracionPage();
        } else if (pageId === 'actaApertura') {
            attachFormActaListener('formActaApertura', 'actaAperturaMessage', STORAGE_KEYS.ACTAS_APERTURA, actasAperturaData, pageId, 'actaAperturaId');
            if (dataForPage && document.getElementById('actaAuditId')) {
                 document.getElementById('actaAuditId').value = dataForPage.id;
                 document.getElementById('actaAuditId').dispatchEvent(new Event('change')); // For pre-filling details based on selected audit
            }
        } else if (pageId === 'gestionHallazgos') {
            renderHallazgosTable('allHallazgosTable');
        } else if (pageId === 'accionesCorrectivas') {
            renderAccionesCorrectivasTable('allAccionesCorrectivasTable');
        }
         else if (pageId === 'reportesGraficas') {
            renderHallazgosPorTipoChart(); 
            renderAccionesCorrectivasChart();
            renderCumplimientoPorNormaChart();
        }


        if (sidebar.classList.contains('open') && window.innerWidth < 992) { sidebar.classList.remove('open'); }
        contentArea.scrollTop = 0;
    }
    
    // --- MANEJO DE FORMULARIOS ---
    function attachFormNuevaAuditoriaListener() { /* ... (Misma lógica que antes) ... */
        const form = document.getElementById('formNuevaAuditoria');
        const msgDiv = document.getElementById('nuevaAuditoriaMessage');

        if (form && !form.dataset.listenerAttached) {
            form.dataset.listenerAttached = 'true';
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const proyecto = document.getElementById('auditNombreProyecto').value.trim();
                const fechaProgramada = document.getElementById('auditFechaProgramada').value; 
                const responsableCliente = document.getElementById('auditResponsableCliente').value.trim();
                const auditorLider = document.getElementById('auditAuditorLider').value; 
                const plantillaSelect = document.getElementById('auditPlantilla'); 
                const plantillaIdUsada = plantillaSelect.value;
                const tipoAuditoriaText = plantillaIdUsada === 'OTRO_ESPECIFICO' ? 'Específica (Personalizada)' : plantillaSelect.options[plantillaSelect.selectedIndex].dataset.templateName || plantillaSelect.options[plantillaSelect.selectedIndex].text;
                const normaReferencia = document.getElementById('auditNormaReferencia').value.trim();
                const alcance = document.getElementById('auditAlcance').value.trim();

                if (!proyecto || !fechaProgramada || !responsableCliente) {
                    if(msgDiv){ msgDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Por favor, complete los campos obligatorios: Proyecto, Fecha Programada y Responsable Cliente.'; msgDiv.className = 'error-message-form'; msgDiv.style.display = 'block';}
                    return;
                }

                const newAudit = {
                    id: `AUD-${new Date().getFullYear()}${String(Date.now()).slice(-5)}`,
                    proyecto: proyecto, fechaProgramada: fechaProgramada, fechaEjecucion: null, responsableCliente: responsableCliente,
                    auditorLider: auditorLider, tipoAuditoriaText: tipoAuditoriaText, plantillaIdUsada: plantillaIdUsada !== 'OTRO_ESPECIFICO' ? plantillaIdUsada : null,
                    estado: 'Pendiente', cumplimiento: null, riesgoGeneral: 'N/D',
                    observacionesGenerales: alcance, normaAdicional: normaReferencia,
                    hallazgosIds: [], accionesCorrectivasIds:[], actaAperturaId: null, actaCierreId: null,
                    checklistResult: [] // Inicializar para resultados del checklist
                };

                auditsData.unshift(newAudit); saveData(STORAGE_KEYS.AUDITS, auditsData);
                
                if(msgDiv) { msgDiv.innerHTML = `<i class="fas fa-check-circle"></i> Auditoría '${newAudit.id}' para '${newAudit.proyecto}' programada exitosamente.`; msgDiv.className = 'success-message'; msgDiv.style.display = 'block'; }
                form.reset(); 
                document.getElementById('auditFechaProgramada').value = new Date().toISOString().split('T')[0];
                document.getElementById('auditAuditorLider').value = auditorLiderActual;

                setTimeout(() => { 
                    if(msgDiv) msgDiv.style.display = 'none';
                    window.location.hash = 'auditoriasActivas'; 
                }, 2200);
            });
        }
    }
    function attachFormActaListener(formId, messageDivId, storageKey, dataArray, pageIdForReload, auditLinkField) { /* ... (Misma lógica que antes) ... */
        const form = document.getElementById(formId);
        const msgDiv = document.getElementById(messageDivId);
        if (form && !form.dataset.listenerAttached) {
            form.dataset.listenerAttached = 'true';
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const auditId = document.getElementById('actaAuditId').value;
                if (!auditId) {
                    if(msgDiv){ msgDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Debe seleccionar una auditoría relacionada.'; msgDiv.className = 'error-message-form'; msgDiv.style.display = 'block';}
                    return;
                }
                const actaData = {
                    id: `${storageKey === STORAGE_KEYS.ACTAS_APERTURA ? 'AAP' : 'ACI'}-${auditId}-${String(Date.now()).slice(-3)}`,
                    auditId: auditId,
                    fecha: document.getElementById(formId.replace('formActa','acta') + 'Fecha').value, 
                };
                if(formId === 'formActaApertura'){
                    actaData.horaInicio = document.getElementById('actaAperturaHoraInicio').value;
                    actaData.lugar = document.getElementById('actaAperturaLugar').value;
                    actaData.participantes = document.getElementById('actaAperturaParticipantes').value;
                    actaData.objetivos = document.getElementById('actaAperturaObjetivos').value;
                    actaData.alcance = document.getElementById('actaAperturaAlcance').value;
                    actaData.criterios = document.getElementById('actaAperturaCriterios').value;
                    actaData.planAuditoria = document.getElementById('actaAperturaPlan').value;
                    actaData.acuerdos = document.getElementById('actaAperturaAcuerdos').value;
                }
                const index = dataArray.findIndex(a => a.auditId === auditId);
                if (index > -1) dataArray.splice(index, 1);
                dataArray.push(actaData);
                saveData(storageKey, dataArray);

                const auditIdx = auditsData.findIndex(a => a.id === auditId);
                if (auditIdx > -1) {
                    auditsData[auditIdx][auditLinkField] = actaData.id; 
                    saveData(STORAGE_KEYS.AUDITS, auditsData);
                }
                if(msgDiv) { msgDiv.innerHTML = `<i class="fas fa-check-circle"></i> Acta guardada para auditoría ${auditId}.`; msgDiv.className = 'success-message'; msgDiv.style.display = 'block'; }
                setTimeout(() => { if(msgDiv) msgDiv.style.display = 'none'; }, 2000);
            });
        }
    }
    
    // --- NUEVAS FUNCIONES PARA EJECUTAR AUDITORÍA ---
    function attachFormNuevoHallazgoListener(auditId) {
        const form = document.getElementById('formNuevoHallazgo');
        const msgDiv = document.getElementById('nuevoHallazgoMessage');
        if (form && !form.dataset.listenerAttachedToHallazgo) { // Evitar duplicar listeners
            form.dataset.listenerAttachedToHallazgo = 'true';
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const tipo = document.getElementById('hallazgoTipo').value;
                const descripcion = document.getElementById('hallazgoDescripcion').value.trim();
                const norma = document.getElementById('hallazgoNorma').value.trim();
                if (!descripcion) {
                    if(msgDiv){ msgDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> La descripción del hallazgo es obligatoria.'; msgDiv.className = 'error-message-form'; msgDiv.style.display = 'block';}
                    return;
                }
                const nuevoHallazgo = {
                    id: `H-${auditId.slice(-3)}-${String(Date.now()).slice(-4)}`,
                    auditId: auditId,
                    itemId: null, // Podría vincularse a un item del checklist si se selecciona
                    tipo: tipo,
                    descripcion: descripcion,
                    norma: norma,
                    evidencia: '', // Placeholder
                    riesgo: 'N/D', // Placeholder
                    accionRecomendada: '' // Placeholder
                };
                hallazgosData.push(nuevoHallazgo);
                saveData(STORAGE_KEYS.HALLAZGOS, hallazgosData);

                // Vincular al auditData
                const auditIndex = auditsData.findIndex(a => a.id === auditId);
                if (auditIndex > -1) {
                    if (!auditsData[auditIndex].hallazgosIds) auditsData[auditIndex].hallazgosIds = [];
                    auditsData[auditIndex].hallazgosIds.push(nuevoHallazgo.id);
                    saveData(STORAGE_KEYS.AUDITS, auditsData);
                }

                if(msgDiv) { msgDiv.innerHTML = `<i class="fas fa-check-circle"></i> Hallazgo '${nuevoHallazgo.id}' agregado.`; msgDiv.className = 'success-message'; msgDiv.style.display = 'block';}
                form.reset();
                renderHallazgosForAudit(auditId); // Re-renderizar lista de hallazgos
                setTimeout(() => { if(msgDiv) msgDiv.style.display = 'none';}, 2000);
            });
        }
    }

    function renderHallazgosForAudit(auditId) {
        const listContainer = document.getElementById('hallazgosListForAudit');
        if (!listContainer) return;
        const hallazgosDeEstaAuditoria = hallazgosData.filter(h => h.auditId === auditId);
        if (hallazgosDeEstaAuditoria.length === 0) {
            listContainer.innerHTML = '<p class="info-message">No hay hallazgos generales registrados para esta auditoría aún.</p>';
            return;
        }
        listContainer.innerHTML = `<ul style="list-style:none; padding-left:0;">${hallazgosDeEstaAuditoria.map(h => `
            <li style="padding:8px; border-bottom:1px solid var(--color-border); font-size:0.9rem;">
               <strong>${h.tipo}:</strong> ${h.descripcion} 
               ${h.norma ? `<br><small><em>Norma/Req.:</em> ${h.norma}</small>` : ''}
            </li>`).join('')}
        </ul>`;
    }

    function attachChecklistListeners(auditId) {
        const audit = auditsData.find(a => a.id === auditId);
        if (!audit) return;
        if (!audit.checklistResult) audit.checklistResult = []; // Asegurar que exista

        document.querySelectorAll('#checklistContainer .checklist-item').forEach(itemDiv => {
            const itemId = itemDiv.dataset.itemId;
            const radios = itemDiv.querySelectorAll(`input[name="qual_${itemId}"]`);
            const observacionTextarea = itemDiv.querySelector('.checklist-observacion-area textarea');
            const observacionAreaDiv = itemDiv.querySelector('.checklist-observacion-area');

            // Cargar estado guardado
            const savedResult = audit.checklistResult.find(r => r.itemId === itemId);
            if (savedResult) {
                radios.forEach(radio => {
                    if (radio.value === savedResult.calificacion) radio.checked = true;
                });
                if(observacionTextarea) observacionTextarea.value = savedResult.observacionTexto || '';
                if(savedResult.calificacion === 'Observacion' || savedResult.calificacion === 'No Cumple') {
                    if(observacionAreaDiv) observacionAreaDiv.style.display = 'block';
                }
            }


            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if(observacionAreaDiv) observacionAreaDiv.style.display = (this.value === 'Observacion' || this.value === 'No Cumple') ? 'block' : 'none';
                    
                    let result = audit.checklistResult.find(r => r.itemId === itemId);
                    if (!result) {
                        result = { itemId: itemId };
                        audit.checklistResult.push(result);
                    }
                    result.calificacion = this.value;
                    // El texto de observación se guardará al finalizar o con botón específico
                    saveData(STORAGE_KEYS.AUDITS, auditsData); // Guardar el estado del checklist en la auditoría
                });
            });

            if(observacionTextarea) {
                observacionTextarea.addEventListener('input', function() { // Guardar observación al escribir
                     let result = audit.checklistResult.find(r => r.itemId === itemId);
                    if (!result) { // Si no hay resultado de calificación aún, pero hay observación
                        result = { itemId: itemId, calificacion: Array.from(radios).find(r=>r.checked)?.value || null };
                        audit.checklistResult.push(result);
                    }
                    result.observacionTexto = this.value;
                    saveData(STORAGE_KEYS.AUDITS, auditsData);
                });
            }
        });
    }


    function attachBtnFinalizarEjecucionListener(auditId) {
        const btn = document.getElementById('btnFinalizarEjecucion');
        if (btn && !btn.dataset.listenerAttached) {
            btn.dataset.listenerAttached = 'true';
            btn.addEventListener('click', function() {
                const auditIndex = auditsData.findIndex(a => a.id === auditId);
                if (auditIndex === -1) return;

                const fechaEjecucion = document.getElementById('auditEjecucionFecha').value;
                const cumplimientoPct = document.getElementById('auditCumplimientoPct').value;
                const riesgoGeneral = document.getElementById('auditRiesgoGeneral').value;
                const resumenEjecutivo = document.getElementById('auditResumenEjecutivo').value;

                if (!fechaEjecucion || !cumplimientoPct || !riesgoGeneral) {
                    alert("Por favor, complete Fecha de Ejecución, % Cumplimiento y Nivel de Riesgo para finalizar.");
                    return;
                }

                auditsData[auditIndex].fechaEjecucion = fechaEjecucion;
                auditsData[auditIndex].cumplimiento = cumplimientoPct;
                auditsData[auditIndex].riesgoGeneral = riesgoGeneral;
                auditsData[auditIndex].observacionesGenerales = resumenEjecutivo; // Guardar resumen
                auditsData[auditIndex].estado = 'Finalizada'; // O 'Revisión' si se necesita aprobación

                // Guardar las observaciones de los items del checklist que se escribieron
                document.querySelectorAll('#checklistContainer .checklist-item').forEach(itemDiv => {
                    const itemId = itemDiv.dataset.itemId;
                    const observacionTextarea = itemDiv.querySelector('.checklist-observacion-area textarea');
                    if(observacionTextarea && observacionTextarea.value.trim() !== ''){
                         let result = auditsData[auditIndex].checklistResult.find(r => r.itemId === itemId);
                         if(result) {
                             result.observacionTexto = observacionTextarea.value.trim();
                         } else { // Si no había calificación pero sí observación
                            auditsData[auditIndex].checklistResult.push({
                                itemId: itemId,
                                calificacion: null, // O la que esté marcada si se quiere
                                observacionTexto: observacionTextarea.value.trim()
                            });
                         }
                    }
                });


                saveData(STORAGE_KEYS.AUDITS, auditsData);
                alert(`Auditoría ${auditId} marcada como Ejecutada/Finalizada.`);
                window.location.hash = '#historialAuditorias';
            });
        }
    }
    
    function loadConfiguracionPage() { /* ... (igual que antes) ... */ 
        contentArea.innerHTML = `
            <section class="custom-card"> <div class="custom-card-header"><h2>Configuración</h2></div> <div class="form-group"> <label for="configAuditorLider">Auditor Líder Principal</label> <input type="text" id="configAuditorLider" value="${auditorLiderActual}"> </div> <div class="form-actions"> <button class="btn btn-primary" id="saveConfigBtn"><i class="fas fa-save"></i> Guardar</button> </div> <div id="configMessage" style="display:none; margin-top:20px;"></div> </section>
            <section class="custom-card"> <div class="custom-card-header"><h2>Datos Locales</h2></div> <p>La aplicación guarda datos en tu navegador. Puedes borrarlos para empezar de nuevo.</p> <button class="btn btn-danger" id="clearDataBtn"><i class="fas fa-trash-alt"></i> Borrar Datos</button> </section>
        `;
        document.getElementById('saveConfigBtn')?.addEventListener('click', () => {
            auditorLiderActual = document.getElementById('configAuditorLider').value; saveData(STORAGE_KEYS.AUDITOR_LIDER, auditorLiderActual);
            const msg = document.getElementById('configMessage'); if(msg) {msg.className='success-message'; msg.innerHTML = '<i class="fas fa-check-circle"></i> Guardado.'; msg.style.display = 'block';}
            setTimeout(() => {if(msg) msg.style.display = 'none';}, 2000);
            const inputAuditor = document.getElementById('auditAuditorLider'); if(inputAuditor) inputAuditor.value = auditorLiderActual;
        });
        document.getElementById('clearDataBtn')?.addEventListener('click', () => {
            if(confirm('¿Borrar TODOS los datos locales? Esta acción no se puede deshacer.')) {
                Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
                alert('Datos borrados. La app se recargará.'); window.location.hash = '#dashboard'; window.location.reload();
            }
        });
    }
    
    // --- NAVEGACIÓN Y MANEJO DE HASH (Igual que antes) ---
    function handleHashChange() {
        let pageId = window.location.hash.substring(1) || 'dashboard';
        let linkForName = document.querySelector(`.nav-trigger[href="#${pageId}"]`);
        let pageName = linkForName ? (linkForName.dataset.pageName || linkForName.textContent.trim()) : 'Página';
        
        const contentGeneratorFunction = pageContents[pageId] || pageContentsDefault[pageId];
        if (!contentGeneratorFunction && pageId !== 'detalleAuditoria' && pageId !== 'ejecutarAuditoria') { 
            pageId = 'dashboard'; 
            linkForName = document.querySelector(`.nav-trigger[href="#dashboard"]`);
            pageName = linkForName.dataset.pageName;
        }
        
        // Evitar recargar innecesariamente si la dataForPage es la misma para detalle/ejecutar
        let auditContextForPage = null;
        if (pageId === 'detalleAuditoria' || pageId === 'ejecutarAuditoria') {
            // Aquí necesitaríamos una forma de saber qué auditoría cargar si se llega por hash directo
            // Por ahora, estas páginas se cargan mejor por click con `dataForPage`
            // Si no hay `dataForPage` y se accede por hash, podríamos mostrar un selector o un mensaje
            // Por simplicidad, si se llega por hash a estas, se mostrará el estado base (selector para ejecutar)
        }

        window.loadContent(pageId, pageName, auditContextForPage);
    }

    document.querySelectorAll('.nav-trigger').forEach(trigger => {
        trigger.addEventListener('click', function(event) {
            event.preventDefault(); const pageId = this.getAttribute('href').substring(1); window.location.hash = pageId; 
        });
    });
    
    window.addEventListener('hashchange', handleHashChange);
    if (!window.location.hash || window.location.hash === "#") { window.location.hash = "#dashboard"; } 
    else { handleHashChange(); } // Carga inicial basada en hash si existe

    // --- Interacción Sidebar (Submenús y Toggle Responsive) ---
    const submenuToggles = document.querySelectorAll('.sidebar-nav .submenu-toggle');
    submenuToggles.forEach(toggle => { 
        toggle.addEventListener('click', function(event) {
            event.preventDefault(); 
            const parentLi = this.parentElement; 
            if (!parentLi) return;
            const currentlyOpen = parentLi.classList.contains('open');

            // Cerrar otros submenús
            document.querySelectorAll('.sidebar-nav li.open').forEach(openLi => {
                if(openLi !== parentLi) { 
                    openLi.classList.remove('open');
                    const openSubmenu = openLi.querySelector('.submenu');
                    if(openSubmenu) openSubmenu.style.maxHeight = "0";
                }
            });

            // Abrir/Cerrar el actual
            if (!currentlyOpen) {
                parentLi.classList.add('open');
                const submenu = parentLi.querySelector('.submenu');
                if (submenu) submenu.style.maxHeight = submenu.scrollHeight + "px";
            } else { 
                 parentLi.classList.remove('open');
                 const submenu = parentLi.querySelector('.submenu');
                 if (submenu) submenu.style.maxHeight = "0";
            }
        });
    });
    if (menuToggleBtn && sidebar) { menuToggleBtn.addEventListener('click', function() { sidebar.classList.toggle('open'); }); }
    document.addEventListener('click', function(event) { 
        if (sidebar.classList.contains('open') && window.innerWidth < 992 && !sidebar.contains(event.target) && !menuToggleBtn.contains(event.target)) {
            sidebar.classList.remove('open');
        }
    });

    if (yearSpan) { yearSpan.textContent = new Date().getFullYear(); } // Actualizar año en footer

});
</script>
</body>
</html>